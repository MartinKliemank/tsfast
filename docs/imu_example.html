---

title: Title
keywords: fastai
sidebar: home_sidebar

summary: "summary"
---
<!--

#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: 90_imu_example.ipynb
# command to build the docs after a change: nbdev_build_docs

-->

<div class="container" id="notebook-container">
    
<div class="cell border-box-sizing code_cell rendered">

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">seqdata.core</span> <span class="k">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">seqdata.model</span> <span class="k">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">fastai2.basics</span> <span class="k">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">fastai2.callback.progress</span> <span class="k">import</span> <span class="o">*</span>
<span class="kn">import</span> <span class="nn">h5py</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">DfHDFCreateWindows</span><span class="p">(</span><span class="n">win_sz</span><span class="p">,</span><span class="n">stp_sz</span><span class="p">,</span> <span class="n">clm</span><span class="p">,</span> <span class="n">fixed_start</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">fixed_end</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;create windows of sequences, splits sequence into multiple items&#39;&#39;&#39;</span>
    <span class="k">def</span> <span class="nf">_inner</span><span class="p">(</span><span class="n">df</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">fixed_start</span> <span class="ow">and</span> <span class="n">fixed_end</span><span class="p">:</span> <span class="k">raise</span> <span class="ne">Exception</span>

        <span class="n">lst_df</span> <span class="o">=</span> <span class="p">[]</span> <span class="c1">#new dataframe for every row</span>
        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
            <span class="k">with</span> <span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">path</span><span class="p">,</span><span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="c1">#TODO make clm optional</span>
<span class="c1">#                 if clm == &#39;&#39;: </span>
<span class="c1">#                     clm = list(f.keys())[0]</span>
                <span class="n">f_len</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="n">clm</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

                <span class="n">n_win</span> <span class="o">=</span> <span class="p">((</span><span class="n">f_len</span><span class="o">-</span><span class="n">win_sz</span><span class="p">)</span><span class="o">//</span><span class="n">stp_sz</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span>
                <span class="n">tmp_df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[[</span><span class="n">idx</span><span class="p">]</span><span class="o">*</span><span class="n">n_win</span><span class="p">];</span> <span class="c1">#duplicate the row of the df multiple times by reference</span>
                <span class="n">lst_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">n_win</span><span class="p">)</span>

                <span class="c1">#every row is a reference so we need to suppress the warning messages while copying</span>
                <span class="n">pd</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">mode</span><span class="o">.</span><span class="n">chained_assignment</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="n">tmp_df</span><span class="p">[</span><span class="s1">&#39;l_slc&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">lst_idx</span><span class="o">*</span><span class="n">stp_sz</span>
                <span class="n">tmp_df</span><span class="p">[</span><span class="s1">&#39;r_slc&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">lst_idx</span><span class="o">*</span><span class="n">stp_sz</span> <span class="o">+</span> <span class="n">win_sz</span>
                <span class="n">pd</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">mode</span><span class="o">.</span><span class="n">chained_assignment</span> <span class="o">=</span> <span class="s1">&#39;warn&#39;</span>

                <span class="n">lst_df</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tmp_df</span><span class="p">)</span>

        <span class="n">res_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">lst_df</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">res_df</span>
    
    <span class="k">return</span> <span class="n">_inner</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">hdf_files</span> <span class="o">=</span> <span class="n">get_hdf_files</span><span class="p">(</span><span class="s1">&#39;/mnt/Data/Systemidentification/Orientation_Estimation/&#39;</span><span class="p">)</span>
<span class="n">src_df</span> <span class="o">=</span> <span class="n">df_source_items</span><span class="p">(</span><span class="n">hdf_files</span><span class="p">,[</span><span class="n">DfHDFCreateWindows</span><span class="p">(</span><span class="n">win_sz</span><span class="o">=</span><span class="mi">1000</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">stp_sz</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span><span class="n">clm</span><span class="o">=</span><span class="s1">&#39;acc&#39;</span><span class="p">)])</span>
<span class="n">src_df</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea output_execute_result">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>path</th>
      <th>l_slc</th>
      <th>r_slc</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>/mnt/Data/Systemidentification/Orientation_Estimation/experiment3_linear_fast_b0_results_myon.mat.hdf5</td>
      <td>0</td>
      <td>1001</td>
    </tr>
    <tr>
      <th>0</th>
      <td>/mnt/Data/Systemidentification/Orientation_Estimation/experiment3_linear_fast_b0_results_myon.mat.hdf5</td>
      <td>10</td>
      <td>1011</td>
    </tr>
    <tr>
      <th>0</th>
      <td>/mnt/Data/Systemidentification/Orientation_Estimation/experiment3_linear_fast_b0_results_myon.mat.hdf5</td>
      <td>20</td>
      <td>1021</td>
    </tr>
    <tr>
      <th>0</th>
      <td>/mnt/Data/Systemidentification/Orientation_Estimation/experiment3_linear_fast_b0_results_myon.mat.hdf5</td>
      <td>30</td>
      <td>1031</td>
    </tr>
    <tr>
      <th>0</th>
      <td>/mnt/Data/Systemidentification/Orientation_Estimation/experiment3_linear_fast_b0_results_myon.mat.hdf5</td>
      <td>40</td>
      <td>1041</td>
    </tr>
  </tbody>
</table>
</div>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">splitter</span> <span class="o">=</span> <span class="n">FuncSplitter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">o</span><span class="p">:</span> <span class="s1">&#39;experiment2&#39;</span> <span class="ow">in</span> <span class="n">Path</span><span class="p">(</span><span class="n">o</span><span class="p">)</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">functools</span> <span class="k">import</span> <span class="n">lru_cache</span>

<span class="k">def</span> <span class="nf">HDF2Sequence</span><span class="p">(</span><span class="n">c_names</span><span class="p">,</span><span class="n">cached</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">_extract_sequence</span><span class="p">(</span><span class="n">hdf_path</span><span class="p">,</span><span class="n">dataset</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">l_slc</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">r_slc</span><span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="k">with</span> <span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="n">hdf_path</span><span class="p">,</span><span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">ds</span> <span class="o">=</span> <span class="n">f</span> <span class="k">if</span> <span class="n">dataset</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">f</span><span class="p">[</span><span class="n">dataset</span><span class="p">]</span>
            <span class="n">l_array</span> <span class="o">=</span> <span class="p">[</span><span class="n">ds</span><span class="p">[</span><span class="n">n</span><span class="p">][:,</span><span class="n">l_slc</span><span class="p">:</span><span class="n">r_slc</span><span class="p">]</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">c_names</span><span class="p">]</span>
            <span class="n">seq</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">(</span><span class="n">l_array</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">tensor</span><span class="p">(</span><span class="n">seq</span><span class="p">)</span>
        
    <span class="n">_exseq</span> <span class="o">=</span> <span class="n">lru_cache</span><span class="p">(</span><span class="n">maxsize</span><span class="o">=</span><span class="kc">None</span><span class="p">)(</span><span class="n">_extract_sequence</span><span class="p">)</span> <span class="k">if</span> <span class="n">cached</span> <span class="k">else</span> <span class="n">_extract_sequence</span>
    
    <span class="k">def</span> <span class="nf">_extract_df_sequence</span><span class="p">(</span><span class="n">item</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">,</span><span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">_exseq</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">item</span><span class="p">))</span>
        
        <span class="n">path</span> <span class="o">=</span> <span class="n">item</span><span class="o">.</span><span class="n">path</span>
        <span class="n">dataset</span> <span class="o">=</span> <span class="n">item</span><span class="o">.</span><span class="n">dataset</span> <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span><span class="s1">&#39;dataset&#39;</span><span class="p">)</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="n">l_slc</span> <span class="o">=</span> <span class="n">item</span><span class="o">.</span><span class="n">l_slc</span> <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span><span class="s1">&#39;l_slc&#39;</span><span class="p">)</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="n">r_slc</span> <span class="o">=</span> <span class="n">item</span><span class="o">.</span><span class="n">r_slc</span> <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span><span class="s1">&#39;r_slc&#39;</span><span class="p">)</span> <span class="k">else</span> <span class="kc">None</span>
        
        <span class="k">if</span> <span class="n">cached</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">_exseq</span><span class="p">(</span><span class="n">path</span><span class="p">,</span><span class="n">dataset</span><span class="p">)[:,</span><span class="n">l_slc</span><span class="p">:</span><span class="n">r_slc</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">_exseq</span><span class="p">(</span><span class="n">path</span><span class="p">,</span><span class="n">dataset</span><span class="p">,</span><span class="n">l_slc</span><span class="p">,</span><span class="n">r_slc</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">_extract_df_sequence</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">class</span> <span class="nc">SeqSlice</span><span class="p">(</span><span class="n">Transform</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Take a slice from an array-like object. Useful for e.g. shifting input and output&#39;&#39;&#39;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">l_slc</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">r_slc</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">l_slc</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">r_slc</span> <span class="o">=</span> <span class="n">l_slc</span><span class="p">,</span><span class="n">r_slc</span>
        
    <span class="k">def</span> <span class="nf">encodes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">o</span><span class="p">):</span> <span class="k">return</span> <span class="n">o</span><span class="p">[:,</span><span class="bp">self</span><span class="o">.</span><span class="n">l_slc</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">r_slc</span><span class="p">]</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">tfms</span><span class="o">=</span><span class="p">[</span>  <span class="p">[</span><span class="n">HDF2Sequence</span><span class="p">([</span><span class="s1">&#39;acc&#39;</span><span class="p">,</span><span class="s1">&#39;gyr&#39;</span><span class="p">,</span><span class="s1">&#39;mag&#39;</span><span class="p">,</span><span class="s1">&#39;opt_quat&#39;</span><span class="p">]),</span><span class="n">SeqSlice</span><span class="p">(</span><span class="n">l_slc</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span><span class="n">toTensorSequencesInput</span><span class="p">],</span>
        <span class="p">[</span><span class="n">HDF2Sequence</span><span class="p">([</span><span class="s1">&#39;opt_quat&#39;</span><span class="p">]),</span><span class="n">SeqSlice</span><span class="p">(</span><span class="n">r_slc</span><span class="o">=-</span><span class="mi">1</span><span class="p">),</span><span class="n">toTensorSequencesOutput</span><span class="p">]]</span>
<span class="n">dsrc</span> <span class="o">=</span> <span class="n">DataSource</span><span class="p">(</span><span class="n">src_df</span><span class="p">,</span><span class="n">tfms</span><span class="o">=</span><span class="n">tfms</span><span class="p">,</span><span class="n">splits</span><span class="o">=</span><span class="n">splitter</span><span class="p">(</span><span class="n">src_df</span><span class="o">.</span><span class="n">path</span><span class="p">))</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># db = dsrc.databunch(bs=128,after_batch=[SeqNoiseInjection(std=[1.1,0.01]),Normalize(axes=[0,1])])</span>
<span class="n">db</span> <span class="o">=</span> <span class="n">dsrc</span><span class="o">.</span><span class="n">databunch</span><span class="p">(</span><span class="n">bs</span><span class="o">=</span><span class="mi">128</span><span class="p">,</span><span class="n">after_batch</span><span class="o">=</span><span class="p">[</span><span class="n">Cuda</span><span class="p">(),</span><span class="n">Normalize</span><span class="p">(</span><span class="n">axes</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">])])</span>
<span class="n">db</span><span class="o">.</span><span class="n">one_batch</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>torch.Size([128, 13, 1000])</pre>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">class</span> <span class="nc">SimpleGRU</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">input_size</span><span class="p">,</span><span class="n">output_size</span><span class="p">,</span><span class="n">num_layers</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">hidden_size</span><span class="o">=</span><span class="mi">100</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rnn</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">GRU</span><span class="p">(</span><span class="n">input_size</span><span class="o">=</span><span class="n">input_size</span><span class="p">,</span><span class="n">hidden_size</span><span class="o">=</span><span class="n">hidden_size</span><span class="p">,</span><span class="n">num_layers</span><span class="o">=</span><span class="n">num_layers</span><span class="p">,</span><span class="n">batch_first</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">final</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Conv1d</span><span class="p">(</span><span class="n">hidden_size</span><span class="p">,</span><span class="n">output_size</span><span class="p">,</span><span class="n">kernel_size</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">out</span><span class="p">,</span><span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rnn</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>
<span class="c1">#         import pdb; pdb.set_trace()</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">out</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">final</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">out</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">class</span> <span class="nc">DualGRU_StateEstimator</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">input_size</span><span class="p">,</span><span class="n">output_size</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">output_layer</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">hidden_size</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span><span class="n">hidden_layer</span><span class="o">=</span><span class="mi">4</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">output_layer</span> <span class="o">=</span> <span class="n">output_layer</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">output_size</span> <span class="o">=</span> <span class="n">output_size</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rnn</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">GRU</span><span class="p">(</span><span class="n">input_size</span><span class="o">=</span><span class="n">input_size</span><span class="p">,</span><span class="n">hidden_size</span><span class="o">=</span><span class="n">hidden_size</span><span class="p">,</span>
                                    <span class="n">num_layers</span><span class="o">=</span><span class="n">hidden_layer</span><span class="p">,</span> <span class="n">batch_first</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="c1">#         self.rnn = QRNN(input_size=input_size,hidden_size=hidden_size,</span>
<span class="c1">#                                     n_layers=hidden_layer, batch_first=True,zoneout=0.4)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">multi</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Conv1d</span><span class="p">(</span><span class="n">hidden_size</span><span class="p">,</span><span class="n">hidden_size</span><span class="p">,</span><span class="n">kernel_size</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>      
        <span class="bp">self</span><span class="o">.</span><span class="n">final</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Conv1d</span><span class="p">(</span><span class="n">hidden_size</span><span class="p">,</span><span class="n">output_size</span><span class="o">*</span><span class="n">output_layer</span><span class="p">,</span><span class="n">kernel_size</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
<span class="c1">#         out,_,_ = self.rnn(out)        </span>
        <span class="n">out</span><span class="p">,</span><span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rnn</span><span class="p">(</span><span class="n">out</span><span class="p">)</span> 
        
        
        <span class="n">out</span> <span class="o">=</span> <span class="n">out</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span> 
        <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">multi</span><span class="p">(</span><span class="n">out</span><span class="p">)</span><span class="o">.</span><span class="n">relu</span><span class="p">()</span>
        <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">final</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>
<span class="c1">#         import pdb; pdb.set_trace()</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">out</span><span class="o">.</span><span class="n">view</span><span class="p">((</span><span class="n">out</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">output_size</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">output_layer</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">out</span><span class="o">.</span><span class="n">permute</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">out</span>

<span class="k">class</span> <span class="nc">DualGRU_Predictor</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">input_size</span><span class="p">,</span><span class="n">output_size</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">hidden_size</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span><span class="n">hidden_layer</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rnn</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">GRU</span><span class="p">(</span><span class="n">input_size</span><span class="o">=</span><span class="n">input_size</span><span class="p">,</span><span class="n">hidden_size</span><span class="o">=</span><span class="n">hidden_size</span><span class="p">,</span>
                                   <span class="n">num_layers</span><span class="o">=</span><span class="n">hidden_layer</span><span class="p">,</span> <span class="n">batch_first</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="c1">#         self.rnn = QRNN(input_size=input_size,hidden_size=hidden_size,</span>
<span class="c1">#                                     n_layers=hidden_layer, batch_first=True,zoneout=0.4,window=1)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">multi</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Conv1d</span><span class="p">(</span><span class="n">hidden_size</span><span class="p">,</span><span class="mi">100</span><span class="p">,</span><span class="n">kernel_size</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>      
        <span class="bp">self</span><span class="o">.</span><span class="n">final</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Conv1d</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span><span class="n">output_size</span><span class="p">,</span><span class="n">kernel_size</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span><span class="n">init_state</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
        <span class="c1">#import pdb; pdb.set_trace()</span>
<span class="c1">#         out,_,hidden = self.rnn(out,init_state)</span>
<span class="c1">#         hidden = hidden.transpose(2,3) </span>
<span class="c1">#         out = out.transpose(1,2)</span>
<span class="c1">#         out = self.multi(out).relu()</span>
        
        <span class="n">hidden</span><span class="p">,</span><span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rnn</span><span class="p">(</span><span class="n">out</span><span class="p">,</span><span class="n">init_state</span><span class="p">)</span> 
        <span class="n">hidden</span> <span class="o">=</span> <span class="n">hidden</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">multi</span><span class="p">(</span><span class="n">hidden</span><span class="p">)</span><span class="o">.</span><span class="n">relu</span><span class="p">()</span> 
        
        <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">final</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">out</span> <span class="k">if</span> <span class="n">out</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="n">out</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">out</span><span class="p">,</span> <span class="n">hidden</span>

<span class="k">class</span> <span class="nc">DualGRU</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">input_size</span><span class="p">,</span><span class="n">init_size</span><span class="p">,</span><span class="n">hidden_size</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span><span class="n">init_layer</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span><span class="n">pred_layer</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">init_size</span> <span class="o">=</span> <span class="n">init_size</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">state_estimator</span> <span class="o">=</span> <span class="n">DualGRU_StateEstimator</span><span class="p">(</span><span class="n">input_size</span><span class="p">,</span><span class="n">output_size</span><span class="o">=</span><span class="n">hidden_size</span><span class="p">,</span><span class="n">output_layer</span><span class="o">=</span><span class="n">pred_layer</span><span class="p">,</span>
                                              <span class="n">hidden_size</span><span class="o">=</span><span class="n">hidden_size</span><span class="p">,</span><span class="n">hidden_layer</span><span class="o">=</span><span class="n">init_layer</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">predictor</span> <span class="o">=</span> <span class="n">DualGRU_Predictor</span><span class="p">(</span><span class="n">input_size</span><span class="o">-</span><span class="mi">4</span><span class="p">,</span><span class="n">output_size</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span>
                                   <span class="n">hidden_size</span><span class="o">=</span><span class="n">hidden_size</span><span class="p">,</span><span class="n">hidden_layer</span><span class="o">=</span><span class="n">pred_layer</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span><span class="n">init_state</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="n">est_states</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state_estimator</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        
<span class="c1">#         import pdb; pdb.set_trace()</span>
        <span class="k">if</span> <span class="n">init_state</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">init_state</span> <span class="o">=</span> <span class="n">est_states</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">init_size</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">contiguous</span><span class="p">()</span>
            <span class="n">pred_vals</span> <span class="o">=</span> <span class="n">x</span><span class="p">[:,:</span><span class="o">-</span><span class="mi">4</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">init_size</span><span class="p">:]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">pred_vals</span> <span class="o">=</span> <span class="n">x</span><span class="p">[:,:</span><span class="o">-</span><span class="mi">4</span><span class="p">]</span>
        <span class="n">out</span><span class="p">,</span><span class="n">pred_states</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">predictor</span><span class="p">(</span><span class="n">pred_vals</span><span class="p">,</span><span class="n">init_state</span><span class="p">)</span>
<span class="c1">#         print(pred_states.shape)</span>
        
        <span class="k">return</span> <span class="n">out</span>
    
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">lrn</span> <span class="o">=</span> <span class="n">Learner</span><span class="p">(</span><span class="n">db</span><span class="p">,</span><span class="n">SimpleGRU</span><span class="p">(</span><span class="mi">13</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="n">num_layers</span><span class="o">=</span><span class="mi">3</span><span class="p">),</span><span class="n">loss_func</span><span class="o">=</span><span class="n">nn</span><span class="o">.</span><span class="n">MSELoss</span><span class="p">())</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">class</span> <span class="nc">DualQRNNTrainer</span><span class="p">(</span><span class="n">Callback</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">begin_batch</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="c1">#         import pdb; pdb.set_trace()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">yb</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">yb</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="o">...</span><span class="p">,</span><span class="mi">100</span><span class="p">:],)</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">lrn</span> <span class="o">=</span> <span class="n">Learner</span><span class="p">(</span><span class="n">db</span><span class="p">,</span><span class="n">DualGRU</span><span class="p">(</span><span class="mi">13</span><span class="p">,</span><span class="mi">100</span><span class="p">,</span><span class="mi">4</span><span class="p">),</span><span class="n">loss_func</span><span class="o">=</span><span class="n">nn</span><span class="o">.</span><span class="n">MSELoss</span><span class="p">(),</span><span class="n">cbs</span><span class="o">=</span><span class="p">[</span><span class="n">DualQRNNTrainer</span><span class="p">()])</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">lrn</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea ">
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: left;">
      <th>epoch</th>
      <th>train_loss</th>
      <th>valid_loss</th>
      <th>time</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>0</td>
      <td>0.000000</td>
      <td>00:01</td>
    </tr>
  </tbody>
</table>
</div>

</div>

<div class="output_area">

<div class="output_subarea output_stream output_stderr output_text">
<pre>/home/daniel/miniconda3/lib/python3.7/site-packages/torch/nn/modules/loss.py:431: UserWarning: Using a target size (torch.Size([128, 4, 1000])) that is different to the input size (torch.Size([128, 4, 900])). This will likely lead to incorrect results due to broadcasting. Please ensure they have the same size.
  return F.mse_loss(input, target, reduction=self.reduction)
</pre>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_text output_error">
<pre>
<span class="ansi-red-fg">---------------------------------------------------------------------------</span>
<span class="ansi-red-fg">RuntimeError</span>                              Traceback (most recent call last)
<span class="ansi-green-fg">&lt;ipython-input-112-d30f7fb12a5a&gt;</span> in <span class="ansi-cyan-fg">&lt;module&gt;</span>
<span class="ansi-green-fg">----&gt; 1</span><span class="ansi-red-fg"> </span>lrn<span class="ansi-blue-fg">.</span>fit<span class="ansi-blue-fg">(</span><span class="ansi-cyan-fg">2</span><span class="ansi-blue-fg">)</span>

<span class="ansi-green-fg">~/miniconda3/lib/python3.7/site-packages/fastai2/learner.py</span> in <span class="ansi-cyan-fg">fit</span><span class="ansi-blue-fg">(self, n_epoch, lr, wd, cbs, reset_opt)</span>
<span class="ansi-green-intense-fg ansi-bold">    281</span>                     <span class="ansi-green-fg">try</span><span class="ansi-blue-fg">:</span>
<span class="ansi-green-intense-fg ansi-bold">    282</span>                         self<span class="ansi-blue-fg">.</span>epoch<span class="ansi-blue-fg">=</span>epoch<span class="ansi-blue-fg">;</span>          self<span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">&#39;begin_epoch&#39;</span><span class="ansi-blue-fg">)</span>
<span class="ansi-green-fg">--&gt; 283</span><span class="ansi-red-fg">                         </span>self<span class="ansi-blue-fg">.</span>_do_epoch_train<span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">)</span>
<span class="ansi-green-intense-fg ansi-bold">    284</span>                         self<span class="ansi-blue-fg">.</span>_do_epoch_validate<span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">)</span>
<span class="ansi-green-intense-fg ansi-bold">    285</span>                     <span class="ansi-green-fg">except</span> CancelEpochException<span class="ansi-blue-fg">:</span>   self<span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">&#39;after_cancel_epoch&#39;</span><span class="ansi-blue-fg">)</span>

<span class="ansi-green-fg">~/miniconda3/lib/python3.7/site-packages/fastai2/learner.py</span> in <span class="ansi-cyan-fg">_do_epoch_train</span><span class="ansi-blue-fg">(self)</span>
<span class="ansi-green-intense-fg ansi-bold">    256</span>         <span class="ansi-green-fg">try</span><span class="ansi-blue-fg">:</span>
<span class="ansi-green-intense-fg ansi-bold">    257</span>             self<span class="ansi-blue-fg">.</span>dl <span class="ansi-blue-fg">=</span> self<span class="ansi-blue-fg">.</span>dbunch<span class="ansi-blue-fg">.</span>train_dl<span class="ansi-blue-fg">;</span>                  self<span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">&#39;begin_train&#39;</span><span class="ansi-blue-fg">)</span>
<span class="ansi-green-fg">--&gt; 258</span><span class="ansi-red-fg">             </span>self<span class="ansi-blue-fg">.</span>all_batches<span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">)</span>
<span class="ansi-green-intense-fg ansi-bold">    259</span>         <span class="ansi-green-fg">except</span> CancelTrainException<span class="ansi-blue-fg">:</span>                         self<span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">&#39;after_cancel_train&#39;</span><span class="ansi-blue-fg">)</span>
<span class="ansi-green-intense-fg ansi-bold">    260</span>         <span class="ansi-green-fg">finally</span><span class="ansi-blue-fg">:</span>                                             self<span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">&#39;after_train&#39;</span><span class="ansi-blue-fg">)</span>

<span class="ansi-green-fg">~/miniconda3/lib/python3.7/site-packages/fastai2/learner.py</span> in <span class="ansi-cyan-fg">all_batches</span><span class="ansi-blue-fg">(self)</span>
<span class="ansi-green-intense-fg ansi-bold">    234</span>     <span class="ansi-green-fg">def</span> all_batches<span class="ansi-blue-fg">(</span>self<span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">:</span>
<span class="ansi-green-intense-fg ansi-bold">    235</span>         self<span class="ansi-blue-fg">.</span>n_iter <span class="ansi-blue-fg">=</span> len<span class="ansi-blue-fg">(</span>self<span class="ansi-blue-fg">.</span>dl<span class="ansi-blue-fg">)</span>
<span class="ansi-green-fg">--&gt; 236</span><span class="ansi-red-fg">         </span><span class="ansi-green-fg">for</span> o <span class="ansi-green-fg">in</span> enumerate<span class="ansi-blue-fg">(</span>self<span class="ansi-blue-fg">.</span>dl<span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">:</span> self<span class="ansi-blue-fg">.</span>one_batch<span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">*</span>o<span class="ansi-blue-fg">)</span>
<span class="ansi-green-intense-fg ansi-bold">    237</span> 
<span class="ansi-green-intense-fg ansi-bold">    238</span>     <span class="ansi-green-fg">def</span> one_batch<span class="ansi-blue-fg">(</span>self<span class="ansi-blue-fg">,</span> i<span class="ansi-blue-fg">,</span> b<span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">:</span>

<span class="ansi-green-fg">~/miniconda3/lib/python3.7/site-packages/fastai2/learner.py</span> in <span class="ansi-cyan-fg">one_batch</span><span class="ansi-blue-fg">(self, i, b)</span>
<span class="ansi-green-intense-fg ansi-bold">    242</span>             self<span class="ansi-blue-fg">.</span>pred <span class="ansi-blue-fg">=</span> self<span class="ansi-blue-fg">.</span>model<span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">*</span>self<span class="ansi-blue-fg">.</span>xb<span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">;</span>                self<span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">&#39;after_pred&#39;</span><span class="ansi-blue-fg">)</span>
<span class="ansi-green-intense-fg ansi-bold">    243</span>             <span class="ansi-green-fg">if</span> len<span class="ansi-blue-fg">(</span>self<span class="ansi-blue-fg">.</span>yb<span class="ansi-blue-fg">)</span> <span class="ansi-blue-fg">==</span> <span class="ansi-cyan-fg">0</span><span class="ansi-blue-fg">:</span> <span class="ansi-green-fg">return</span>
<span class="ansi-green-fg">--&gt; 244</span><span class="ansi-red-fg">             </span>self<span class="ansi-blue-fg">.</span>loss <span class="ansi-blue-fg">=</span> self<span class="ansi-blue-fg">.</span>loss_func<span class="ansi-blue-fg">(</span>self<span class="ansi-blue-fg">.</span>pred<span class="ansi-blue-fg">,</span> <span class="ansi-blue-fg">*</span>self<span class="ansi-blue-fg">.</span>yb<span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">;</span> self<span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">&#39;after_loss&#39;</span><span class="ansi-blue-fg">)</span>
<span class="ansi-green-intense-fg ansi-bold">    245</span>             <span class="ansi-green-fg">if</span> <span class="ansi-green-fg">not</span> self<span class="ansi-blue-fg">.</span>training<span class="ansi-blue-fg">:</span> <span class="ansi-green-fg">return</span>
<span class="ansi-green-intense-fg ansi-bold">    246</span>             self<span class="ansi-blue-fg">.</span>loss<span class="ansi-blue-fg">.</span>backward<span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">;</span>                            self<span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">&#39;after_backward&#39;</span><span class="ansi-blue-fg">)</span>

<span class="ansi-green-fg">~/miniconda3/lib/python3.7/site-packages/torch/nn/modules/module.py</span> in <span class="ansi-cyan-fg">__call__</span><span class="ansi-blue-fg">(self, *input, **kwargs)</span>
<span class="ansi-green-intense-fg ansi-bold">    539</span>             result <span class="ansi-blue-fg">=</span> self<span class="ansi-blue-fg">.</span>_slow_forward<span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">*</span>input<span class="ansi-blue-fg">,</span> <span class="ansi-blue-fg">**</span>kwargs<span class="ansi-blue-fg">)</span>
<span class="ansi-green-intense-fg ansi-bold">    540</span>         <span class="ansi-green-fg">else</span><span class="ansi-blue-fg">:</span>
<span class="ansi-green-fg">--&gt; 541</span><span class="ansi-red-fg">             </span>result <span class="ansi-blue-fg">=</span> self<span class="ansi-blue-fg">.</span>forward<span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">*</span>input<span class="ansi-blue-fg">,</span> <span class="ansi-blue-fg">**</span>kwargs<span class="ansi-blue-fg">)</span>
<span class="ansi-green-intense-fg ansi-bold">    542</span>         <span class="ansi-green-fg">for</span> hook <span class="ansi-green-fg">in</span> self<span class="ansi-blue-fg">.</span>_forward_hooks<span class="ansi-blue-fg">.</span>values<span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">:</span>
<span class="ansi-green-intense-fg ansi-bold">    543</span>             hook_result <span class="ansi-blue-fg">=</span> hook<span class="ansi-blue-fg">(</span>self<span class="ansi-blue-fg">,</span> input<span class="ansi-blue-fg">,</span> result<span class="ansi-blue-fg">)</span>

<span class="ansi-green-fg">~/miniconda3/lib/python3.7/site-packages/torch/nn/modules/loss.py</span> in <span class="ansi-cyan-fg">forward</span><span class="ansi-blue-fg">(self, input, target)</span>
<span class="ansi-green-intense-fg ansi-bold">    429</span> 
<span class="ansi-green-intense-fg ansi-bold">    430</span>     <span class="ansi-green-fg">def</span> forward<span class="ansi-blue-fg">(</span>self<span class="ansi-blue-fg">,</span> input<span class="ansi-blue-fg">,</span> target<span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">:</span>
<span class="ansi-green-fg">--&gt; 431</span><span class="ansi-red-fg">         </span><span class="ansi-green-fg">return</span> F<span class="ansi-blue-fg">.</span>mse_loss<span class="ansi-blue-fg">(</span>input<span class="ansi-blue-fg">,</span> target<span class="ansi-blue-fg">,</span> reduction<span class="ansi-blue-fg">=</span>self<span class="ansi-blue-fg">.</span>reduction<span class="ansi-blue-fg">)</span>
<span class="ansi-green-intense-fg ansi-bold">    432</span> 
<span class="ansi-green-intense-fg ansi-bold">    433</span> 

<span class="ansi-green-fg">~/miniconda3/lib/python3.7/site-packages/torch/nn/functional.py</span> in <span class="ansi-cyan-fg">mse_loss</span><span class="ansi-blue-fg">(input, target, size_average, reduce, reduction)</span>
<span class="ansi-green-intense-fg ansi-bold">   2201</span>             ret <span class="ansi-blue-fg">=</span> torch<span class="ansi-blue-fg">.</span>mean<span class="ansi-blue-fg">(</span>ret<span class="ansi-blue-fg">)</span> <span class="ansi-green-fg">if</span> reduction <span class="ansi-blue-fg">==</span> <span class="ansi-blue-fg">&#39;mean&#39;</span> <span class="ansi-green-fg">else</span> torch<span class="ansi-blue-fg">.</span>sum<span class="ansi-blue-fg">(</span>ret<span class="ansi-blue-fg">)</span>
<span class="ansi-green-intense-fg ansi-bold">   2202</span>     <span class="ansi-green-fg">else</span><span class="ansi-blue-fg">:</span>
<span class="ansi-green-fg">-&gt; 2203</span><span class="ansi-red-fg">         </span>expanded_input<span class="ansi-blue-fg">,</span> expanded_target <span class="ansi-blue-fg">=</span> torch<span class="ansi-blue-fg">.</span>broadcast_tensors<span class="ansi-blue-fg">(</span>input<span class="ansi-blue-fg">,</span> target<span class="ansi-blue-fg">)</span>
<span class="ansi-green-intense-fg ansi-bold">   2204</span>         ret <span class="ansi-blue-fg">=</span> torch<span class="ansi-blue-fg">.</span>_C<span class="ansi-blue-fg">.</span>_nn<span class="ansi-blue-fg">.</span>mse_loss<span class="ansi-blue-fg">(</span>expanded_input<span class="ansi-blue-fg">,</span> expanded_target<span class="ansi-blue-fg">,</span> _Reduction<span class="ansi-blue-fg">.</span>get_enum<span class="ansi-blue-fg">(</span>reduction<span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">)</span>
<span class="ansi-green-intense-fg ansi-bold">   2205</span>     <span class="ansi-green-fg">return</span> ret

<span class="ansi-green-fg">~/miniconda3/lib/python3.7/site-packages/torch/functional.py</span> in <span class="ansi-cyan-fg">broadcast_tensors</span><span class="ansi-blue-fg">(*tensors)</span>
<span class="ansi-green-intense-fg ansi-bold">     50</span>                 [0, 1, 2]])
<span class="ansi-green-intense-fg ansi-bold">     51</span>     &#34;&#34;&#34;
<span class="ansi-green-fg">---&gt; 52</span><span class="ansi-red-fg">     </span><span class="ansi-green-fg">return</span> torch<span class="ansi-blue-fg">.</span>_C<span class="ansi-blue-fg">.</span>_VariableFunctions<span class="ansi-blue-fg">.</span>broadcast_tensors<span class="ansi-blue-fg">(</span>tensors<span class="ansi-blue-fg">)</span>
<span class="ansi-green-intense-fg ansi-bold">     53</span> 
<span class="ansi-green-intense-fg ansi-bold">     54</span> 

<span class="ansi-red-fg">RuntimeError</span>: The size of tensor a (900) must match the size of tensor b (1000) at non-singleton dimension 2</pre>
</div>
</div>

</div>
</div>

</div>
</div>
 

